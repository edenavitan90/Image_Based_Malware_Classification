import xlsxwriter
import os
import math
import numpy as np
from PIL import Image
from numpy import array

def data_mapping(path, file_name):
    workbook = xlsxwriter.Workbook("{}.xlsx".format(file_name))
    worksheet = workbook.add_worksheet()
    worksheet.write(0, 0, "No.")
    worksheet.write(0, 1, "Image Path")
    worksheet.write(0, 2, "Malware Family")
    worksheet.write(0, 3, "Uses (learning / testing)")

    col = 0
    row = 0
    path = os.walk(path)
    for root, directories, files in path:
        for path in os.listdir(root):
            full_path = os.path.join(root, path)
            if os.path.isfile(full_path):
                row += 1
                worksheet.write(row, col, row)
                worksheet.write(row, col + 1, "\\" + full_path)
                worksheet.write(row, col + 2, full_path.split('\\')[len(full_path.split('\\')) - 2])
                #if file_name != "mapped-original-data":

                #    print(r"{}. Vectorize images for {}".format(row, file_name))
                #    img_vector = vectorize_img(full_path)
                #    for i in range(len(img_vector)):
                #        worksheet.write(row, col + 4 + i, img_vector[i] / 255)

    number_of_images_for_testing = math.ceil((row / 100) * 10)    # rounds up
    number_of_images_for_learning = math.floor((row / 100) * 90)  # rounds down

    image_count = row
    row = 0
    testing = 0
    training = 0
    for i in range(image_count):
        row += 1
        if row % 10 < 9:
            worksheet.write(row, 3, "training")
            training += 1
        else:
            worksheet.write(row, 3, "testing")
            testing += 1
    workbook.close()
    print(f"testing: {testing} / {number_of_images_for_testing} images")
    print(f"training: {training} / {number_of_images_for_learning} images")
    print(f"Total images == {testing + training}")



def vectorize_img(path):
    img = Image.open(path)
    img_vector = np.ravel(array(img))
    return img_vector



#data_mapping("malimg_paper_dataset_imgs", "mapped-original-data")
#data_mapping("resized_images/128x128_malimg_paper_dataset_imgs", "mapped-128x128-data")